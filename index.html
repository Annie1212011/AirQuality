<!DOCTYPE html>
<html>
<head>
  <title>Arduino API Proxy</title>
  <script>
    // This function handles both GET and POST requests
    async function handleRequest() {
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const gsid = urlParams.get('gsid');
      const method = urlParams.get('method') || 'GET';
      
      if (!gsid) {
        document.getElementById('response').textContent = 'Error: Missing gsid parameter';
        return;
      }

      // Construct the Google Script URL
      const googleScriptUrl = `https://script.google.com/macros/s/${gsid}/exec`;
      
      // Create a new URL object to properly handle additional parameters
      const targetUrl = new URL(googleScriptUrl);
      
      // Copy all parameters except gsid and method
      for (const [key, value] of urlParams.entries()) {
        if (key !== 'gsid' && key !== 'method') {
          targetUrl.searchParams.append(key, value);
        }
      }
      
      try {
        // Make the request to Google Script
        const response = await fetch(targetUrl.toString(), {
          method: method,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'User-Agent': 'Arduino-WiFi101'
          }
        });
        
        // Get the response as text
        const data = await response.text();
        
        // Display the response (useful for debugging)
        document.getElementById('response').textContent = data;
        
        // Also return the response as plain text for API requests
        document.getElementById('plaintext').textContent = data;
      } catch (error) {
        document.getElementById('response').textContent = `Error: ${error.message}`;
        document.getElementById('plaintext').textContent = `Error: ${error.message}`;
      }
    }
    
    // Run the handler when the page loads
    window.onload = handleRequest;
  </script>
</head>
<body>
  <!-- This displays formatted response for browser viewing -->
  <pre id="response"></pre>
  
  <!-- This is for plain text responses that Arduino can parse -->
  <div id="plaintext" style="display:none;"></div>
</body>
</html>
