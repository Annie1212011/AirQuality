<!DOCTYPE html>
<html>
<head>
  <title>Arduino Air Quality Sensor Proxy</title>
  <script>
    async function handleRequest() {
      // Get parameters from URL
      const urlParams = new URLSearchParams(window.location.search);
      const gsid = urlParams.get('gsid');
      const payload = urlParams.get('payload');
      
      if (!gsid) {
        document.getElementById('response').textContent = 'Error: Missing gsid parameter';
        return;
      }

      if (!payload) {
        document.getElementById('response').textContent = 'Error: Missing payload parameter';
        return;
      }

      try {
        // Log what we received (helpful for debugging)
        console.log("GSID:", gsid);
        console.log("Payload:", payload);
        
        // Construct the Google Script URL
        const googleScriptUrl = `https://script.google.com/macros/s/${gsid}/exec`;
        
        // Decode the URL-encoded payload
        const decodedPayload = decodeURIComponent(payload);
        
        // Make the request to Google Script
        const response = await fetch(googleScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: decodedPayload  // Send the decoded JSON payload
        });
        
        // Get and display the response
        const data = await response.text();
        document.getElementById('response').textContent = 'Response from Google: ' + data;
        
        // Also add to log for debugging
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toISOString();
        logDiv.innerHTML += `<p>${timestamp}: ${data}</p>`;
      } catch (error) {
        document.getElementById('response').textContent = `Error: ${error.message}`;
        
        // Log error for debugging
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toISOString();
        logDiv.innerHTML += `<p>${timestamp}: ERROR - ${error.message}</p>`;
      }
    }
    
    // Run the handler when the page loads
    window.onload = handleRequest;
  </script>
</head>
<body>
  <h1>Arduino Air Quality Sensor Proxy</h1>
  <div id="response">Processing request...</div>
  
  <h2>Log (most recent requests):</h2>
  <div id="log"></div>
</body>
</html>
